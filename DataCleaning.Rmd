---
title: "Aging Dependence Data Cleaning"
author: "Analeidi Barrera and Colleen Minnihan"
date: "2/16/2021"
output: html_document
---


```{r}
#Path to the aging data
path_data = '/Users/ColleenMinnihan/Desktop/Survival_Analysis/ICPSR_08719/DS0001/08719-0001-Data.por'
```

```{r}
library(haven)
library(dplyr)
data <- read_por(path_data)
```


#==================================

```{r}
library(haven)
library(dplyr)
data <- read_por('/Users/analeidibarrera/Desktop/ProjectInformation/ICPSR_08719/DS0001/08719-0001-Data.por')
```


```{r}
#selecting covariates

aging <- data %>% select(TLKCHL2, TLKCHL3, TLKCHL4, SEECHL2, SEECHL3, SEECHL4, MLCHL2R, MLCHL3R, MLCHL4R, CHLTME2R, CHLTME3R, CHLTME4R, WKSWORK2, WKSWORK3, WKSWORK4, MARSTAT2, MARSTAT3, MARSTAT4, DIFDRES2,DIFDRES3, DIFDRES4, BATH2R, BATH3R, BATH4R, TOILET2R, TOILET3R, TOILET4R, EAT2R, EAT3R, EAT4R, DIFPREP2, DIFPREP3, DIFPREP4, GET2R, GET3R, GET4R, DIFLTHW2, DIFLTHW3,  DIFLTHW4, DIFHSWK2, DIFHSWK3 , DIFHSWK4 , DIFTEL2 , DIFTEL3 , DIFTEL4,DIFMNY2, DIFMNY3, DIFMNY4, DIFSHOP2, DIFSHOP3, DIFSHOP4, DIFOUT2, DIFOUT3, DIFOUT4, DIFWALK2, DIFWALK3, DIFWALK4, BIRTHYR, RACER, SEX)

```



### Creating a KM curve for bathing (BATH2R), using the toilet(TOILET2R), and eating(EAT2R)

In our data we have the following categories:

1: Independent

2: Dependent

3: Don't know,... refused, does not do for other than health reasons


*For the purpose of this analysis, we are assuming that a (3) or no data means that nothing has changed from the previous information obtained. If no previous information was recorded, we assume the person is independent. 

**The edge case of (1, _, 2) is a left censoring scenario since we only have an upper bound. We are assuming the above assumption is true

The participants that we are considering are the following:
- They must have started as independent at whatever year we had concrete information (2 or 1) on them
 

#### Creating a subset data with the targeted dependence/response variables

```{r}
#BATH
bath <- aging %>% filter(BATH2R != "2" & (BATH2R == "1" |BATH3R == "1" | BATH4R == "1") & !(BATH3R == "2" & BATH4R == "1"))

#TOILET
toilet <- aging %>% filter(TOILET2R != "2" & (TOILET2R == "1" |TOILET3R == "1" | TOILET4R == "1") & !(TOILET3R == "2" & TOILET4R == "1"))

#EAT 
eat <- aging %>% filter(EAT2R != "2" & (EAT2R == "1" |EAT3R == "1" | EAT4R == "1") & !(EAT3R == "2" & EAT4R == "1"))

```


The following are the data sizes that we are working with:

Bathing or showering dependence = 5207 participants

```{r}
count(bath)
```

Using or getting to the toilet dependence = 5619 participants

```{r}
count(toilet)
```


Eating dependence = 5904 participants
```{r}
count(eat)

#==================================

Looking into the age distribution of bathroom dependence

```{r}
#Creating a new variable called BATHDEPYR to show when they began dependent
bathData$BATHDEPYR <- ifelse(bathData$BATH3R == "2", 1988, 1990)
```


```{r}
#Showing which are censored data
bathData$status <- ifelse(bathData$BATH4R == "1", 0, 1)
```


```{r}
#age to bath dependence
bathData$AGE <- (bathData$BATHDEPYR - as.integer(as.character(bathData$BIRTHYR)))

#If the person did not want to answer their birthday year would have been 9999

bathData <- filter(bathData, bathData$AGE > 0) 
```



```{r}
bathData %>%
  select(TLKCHL2) %>%
  table()
```



```{r}
#The following is a Kaplan Meier curve for the time a person becomes dependent with taking a shower
library(survival)
bathKM= survfit(Surv(bathData$AGE, bathData$status) ~ RACE , data=bathData )
plot(bathKM, conf.int=FALSE, ylab="Survival Proportion" , xlab="Years", xlim = c(min(bathData$AGE), max(bathData$AGE)), ylim = c(0,1))

```


```{r}
bathKM
```


The median age to have bathroom dependence is 88 years
```{r}
#The median age of having bathroom dependence 
bathKM
```


The mean age of having bathroom dependence is 87.94954 years
```{r}
#Using Victor's code to find the mean age of having bathroom dependence

AUCKM = function(survobj,duration)
{
base=c(0,summary(survobj)$time,max(duration))
heights=c(1,summary(survobj)$surv)
new=c()
for(i in 1:length(heights)) { new=c(new,(base[i+1]-base[i])*heights[i]) }
c(sum(new))
}

AUCKM(bathKM, bathData$AGE)
```






dependence:
-treat "dontknow/refuse" as missing
-if they aren't dependent in 1986: keep
-if they are dependent in 1986: use only if necessary (if not enough data)

PROCESS
-check when the 1s change to 2s
-record the year that that happens
-subtract the birthyear (gives us age when they became dependent) and make status variable ==1

-if it never becomes 2
-take last survey year
-subtract birthyear and make status ==0

-we will have age/status pair for each dependency kind

GOAL:
-do procress for bathing


Some project analysis ideas are:
-create survival curves for specific covariates (get the CI, mean, and median) using KM curves
- From the KM curves that look the most interesting, choose the parametric model that fits it best (Cox-Snell(graphically check), Likelihood Ratio Test, AIC)
- Compare variables to each other (Log Rank Test and Hazard Ratio )


Some covariate could potentilly be time-varying
-Recurrent Events (look into this)
